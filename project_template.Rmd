---
title: "Predicting Health Insurance Costs in the United States Using Patient Medical History"
author: "Zara Nip and Nehal Linganur"
date: "05/05/2023"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r, echo=FALSE, message = FALSE, results = FALSE, warning=FALSE}
# library load statements here- remember, no install statements.
# some useful libraries you may find useful:
library(knitr) # for rendering tables with the kable function.
library(dplyr)
library(ggplot2)
library(NbClust)
library(mclust)
library(flexclust)
library(cluster)
library(fpc)

insurance <- read.csv("insurance.csv")
insurance <- na.omit(insurance)
insurance$age <- as.numeric(insurance$age)
insurance$bmi <- as.numeric(insurance$bmi)
insurance$sex <- as.factor(insurance$sex)
insurance$smoker <- as.factor(insurance$smoker)
insurance$region <- as.factor(insurance$region)

connecticut <- read.csv("Insurance_Company_Complaints__Resolutions__Status__and_Recoveries.csv")
```

## 1. Project Overview. 

Which factors impact an individual’s health insurance premium the most? Which factors are statistically significant? Given a sample person’s data, x, can we determine how much they will be charged? We hope to help people understand if they are overpaying or underpaying for health insurance compared to their peers. Government officials may also find this data useful for making conclusions about the overall affordability of health insurance. Please note this report only covers the mainland U.S.

We additionally wanted to make a more comprehensive report of additional Connecticut data, given the first data set covers very broad regions and has already been cleaned up. Because the Connecticut data is publicly available, most information about the patients themselves are ommitted. Instead of factors going into a patient's insurance cost, we are interested in the correlation between "reason" and "subreason" for insurance companies covering certain costs. Additional material includes how long the ticket was openned and when it was closed.

Our domain spans finance, because of the insurance component; healthcare; and demographics, including sex, age, and number of children.

## 2. Data and Resources Used.

Our main data set is from Kaggle (https://www.kaggle.com/datasets/mirichoi0218/insurance). We initially were unsure of which variables were significant or not, hence our approach to take all factors into account (age, sex, bmi, children, smoker status, region) and finding which ones were statistically significant. The variables are described below.

All empty rows were preeminently ommitted. There was no other data cleaning involved.

Age: This variable measures the patient's age at the time of the hospital bill's creation.
: Data Type: numeric
: Range/Levels: 24-80

```{r, echo=FALSE, message = FALSE, results = TRUE, warning=FALSE}
hist(insurance$age, xlab = 'Age Brackets', main = 'Distribution of Patient Ages', breaks = 15)

```
As we see from the graph above, each age group of intervals of 5 has relatively similar frequencies in our data set, and there is no outlying skew to the age.

Sex: This variable measures the patient's sex assigned at birth.
: Data Type: categorical
: Range/Levels: "male", "female"
```{r, echo=FALSE, message = FALSE, results = TRUE, warning=FALSE}
table(insurance$sex)
prop.table(table(insurance$sex))
```
The table shows the number of females and males in our data set, along with their proportions.

BMI: This variable measures the patient's BMI.
: Data Type: numeric
: Range/Levels: 15.96-53.13

```{r, echo=FALSE, message = FALSE, results = TRUE, warning=FALSE}
data <- insurance$bmi
hist_data <- hist(insurance$bmi, main = "Distribution of Patient BMI", breaks = 30, xlab = "BMI")
x_values <- seq(min(data), max(data), length = 100)
y_values <- dnorm(x_values, mean = mean(data), sd = sd(data)) 
y_values <- y_values * diff(hist_data$mids[1:2]) * length(data) 

#overlay normal curve on histogram
lines(x_values, y_values, lwd = 2)

```
Patient BMI levels follow a normal distribution around BMI = 30. 

Children: This variable measures how many children the patient has.
: Data Type: numeric
: Range/Levels: 0-5

Smoker: This variable measures if the patient smokes.
: Data Type: categorical
: Range/Levels: "yes", "no"

```{r, echo=FALSE, message = FALSE, results = TRUE, warning=FALSE}
table(insurance$smoker)
prop.table(table(insurance$smoker))
na.omit(connecticut)
```
About 20% of patients smoke. The CDC (link in "References" section) estimated in 2021 that 11.5% of Americans smoke. We can see a higher proportion of smokers are admitted as patients in hospitals.

Region: This variable measures which region of continental USA the patient is located in.
: Data Type: categorical
: Range/Levels: "northeast", "northwest", "southeast", "southwest"
```{r, echo=FALSE, message = FALSE, results = TRUE, warning=FALSE}
prop.table(table(insurance$region))
range(insurance$charges)
```
The frequency of patients from all four regions is relatively the same, with the southeast region having slightly more patients than the other three regions.

Charges: This is our predictor variable, which we will be using the other factors to estimate
: Data Type: numerical
: Range/Levels: 1121.874-63770.428

Our Connecticut data is from publicly available government data found at https://catalog.data.gov/dataset/insurance-company-complaints-resolutions-status-and-recoveries. The variables include insurance company, file openning date, file closing date, coverage, reason for filing claim (and a more detailed subreason column), recovery amount to patient, and status of insurance covered. 

Company: This variable measures the patient's insurance companies.
: Data Type: categorical
: Range/Levels: 753 companies/levels

```{r, echo=FALSE, message = FALSE, results = TRUE, warning=FALSE}
connecticut$Company <- as.factor(connecticut$Company)
```

<!-- Describe where you obtained data from, what variables you used, their data types and distributions. Clearly describe what the variables measure. -->

<!-- Include plots and tables to show the ranges and distributions of the important variables- you don’t necessarily have to do this for all variables, just the important ones. Do not display a raw summary of the entire dataset (data dump). Mention any modifications to the data (cleaning). Links to data sources go in the References section at the end of the doc. -->

Opened and Closed: These two variable measures when the patient file was opened and closed.
: Data Type: numerical
: Range/Levels: Date Opened (01/01/2022 - 12/31/2022) and Date Closed ("" - 12/30/2022). Some cases were not closed by the end of the year, hence why the value for Closed is empty.

```{r, echo=FALSE, message = FALSE, results = TRUE, warning=FALSE}
range(connecticut$Closed)
```
Reason: This variable measures the reason for the insurance claim.
: Data Type: categorical
: Range/Levels: 5 levels: "", "Claim Handling", "Marketing & Sales", "PolicyHolder Service", and "Underwriting"

```{r, echo=FALSE, message = FALSE, results = TRUE, warning=FALSE}
connecticut$Reason <- as.factor(connecticut$Reason)

barplot(table(connecticut$Reason),las=2, cex.names=.5,)
```
Reason: This variable measures the reason for the insurance claim.
: Data Type: categorical
: Range/Levels: 176 levels. Examples include "Provider Availability" and "Service Fees".

```{r, echo=FALSE, message = FALSE, results = TRUE, warning=FALSE}
connecticut$SubReason<- as.factor(connecticut$SubReason)

```
These subreasons are matched to a larger, more broad "Reason" tag.

Conclusion: We are using this variable to see if the patient's claims were accepted by insurance companies.
: Data Type: categorical
: Range/Levels: 52 levels from "Accident in Another State" to "Voluntary Reconsideration"

```{r, echo=FALSE, message = FALSE, results = TRUE, warning=FALSE}
connecticut$Conclusion <- as.factor(connecticut$Conclusion)

```

## 3. Analysis.

<!-- This is where you explain the methods you used to carry out the analysis to investigate the guiding question(s). State what techniques you used, what variables were included. Identify the independent and dependent variables. Did you preprocess the data? Include the results of any modeling and explain what they mean. -->

### Linear Regression Models

```{r echo=FALSE, out.width="75%", out.height="75%", fig.cap = "Bar Plot Example base R", fig.align = 'center'}
mod<-lm(charges~., data=insurance)
summary(mod)
```
Finding residuals and QQ plots for all factors
```{r echo=FALSE, out.width="75%", out.height="75%", fig.cap = "Bar Plot Example base R", fig.align = 'center'}
par(mfrow=c(1,2))
hist(mod$residuals, prob = TRUE)
lines(density(mod$residuals))

qqnorm(y=mod$residuals)
qqline(y=mod$residuals, datax = FALSE)
```


Using only statistically significant factors: age, bmi, children, smoker (yes).
```{r echo=FALSE, out.width="75%", out.height="75%", fig.cap = "Bar Plot Example base R", fig.align = 'center'}
sigFac<-lm(charges~age + bmi + children + smoker, data=insurance)
summary(sigFac)
```
### Residual Plots
```{r echo=FALSE, out.width="75%", out.height="75%", fig.cap = "Bar Plot Example base R", fig.align = 'center'}
par(mfrow=c(1,2))
hist(sigFac$residuals, prob = TRUE)
lines(density(sigFac$residuals))

qqnorm(y=sigFac$residuals)
qqline(y=sigFac$residuals, datax = FALSE)
```
### Testing Correlation With Clustering
Our previous model stated that age, bmi, children, smoker (yes) were all significant factors. We are now going to perform a clustering model to see if this still holds true.

```{r echo=FALSE, out.width="75%", out.height="75%", fig.cap = "Bar Plot Example base R", fig.align = 'center'}
seed.val<-1234

insurance.scaled <- scale(insurance[1] + insurance[3]) 
for(i in 1:ncol(insurance.scaled)){
print(max(insurance.scaled[ , i]))
}

```
```{r}
RNGversion("4.1.2")
set.seed(seed.val)


clusterInsurance <- kmeans(insurance.scaled, 2, nstart = 25)
```

```{r echo=FALSE, out.width="75%", out.height="75%", fig.cap = "Bar Plot Example base R", fig.align = 'center'}
clusterInsurance$size
clusterInsurance$tot.withinss
clusterInsurance$betweenss
```

```{r echo=FALSE, out.width="75%", out.height="75%", fig.cap = "Bar Plot Example base R", fig.align = 'center'}
wssplot <- function(data, nc=15, seed=1234){
               wss <- (nrow(data)-1)*sum(apply(data,2,var))
               for (i in 2:nc){
                    set.seed(seed)
                    wss[i] <- sum(kmeans(data, centers=i)$withinss)}
                plot(1:nc, wss, main = "Finding Optimal Number of Clusters using Within Group Sum of Squares", type="b", xlab="Number of Clusters",
                     ylab="Within groups sum of squares")
}

wssplot(insurance.scaled)
```

```{r echo=FALSE, out.width="75%", out.height="75%", fig.cap = "Bar Plot Example base R", fig.align = 'center'}
plotcluster(insurance.scaled, clusterInsurance$cluster)
title("Graphical Representation of Clusters")
```
Commented out because of knitting issues. Returned k = 2 as optimal amount of clusters.

#nc <- NbClust(insurance.scaled, min.nc=2, max.nc=15, method="kmeans")

#table(nc$Best.n[1,])

Optimal number of clusters using PAM
```{r echo=FALSE, out.width="75%", out.height="75%", fig.cap = "Bar Plot Example base R", fig.align = 'center'}
dist.mat<-daisy(insurance.scaled,  metric="euclidean")
pk <- pamk(dist.mat, krange=2:15, usepam=TRUE, diss=TRUE)
pk$nc
```

```{r echo=FALSE, out.width="75%", out.height="75%", fig.cap = "Bar Plot Example base R", fig.align = 'center'}
fit.pam = pam(dist.mat,2)
plot(fit.pam)

jpeg("MYPLOT.jpg")
plot(fit.pam)
dev.off()
```
Chi-Squared Test
```{r echo=FALSE, out.width="75%", out.height="75%", fig.cap = "Bar Plot Example base R", fig.align = 'center'}
cont.table <- table(insurance$charges, clusterInsurance$cluster)
print(chisq.test(cont.table))
```
How different are the clusters?
```{r echo=FALSE, out.width="75%", out.height="75%", fig.cap = "Bar Plot Example base R", fig.align = 'center'}
randIndex(cont.table)

```


\newpage

## Summary and Conclusions.

In this section, you briefly summarize what you did and state the conclusions that you have determined based on the results of what you did in the analysis part above. This should be a single paragraph. It is important to clearly state what you conclude about your results. Point out any possible problems that you that may have an effect on your conclusions. For example, small data size, lot of missing values, suspected 

## References

This part is a list of links to the data set(s) you used. Also include links to any resources you used in your project, such as code examples that you adapted to your project or tutorials on analysis techniques that were an important part of your project. You do not have to list any resources from our course material or from R documentation.

* https://www.statology.org/overlay-normal-curve-histogram-in-r/
* https://www.datacamp.com/tutorial/make-histogram-basic-r

Academic References

* https://www.cdc.gov/tobacco/data_statistics/fact_sheets/adult_data/cig_smoking/index.htm#:~:text=This%20means%20an%20estimated%2028.3,with%20a%20smoking%2Drelated%20disease.&text=Current%20smoking%20has%20declined%20from,every%20100%20adults)%20in%202021.




















